rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: check if user is authenticated
    function isAuth() {
      return request.auth != null;
    }

    // Helper: check if user owns the document
    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    // Helper: check if user has admin role
    function isAdmin() {
      return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN';
    }

    // Users: owner can read/write own doc, admin can read all
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
    }

    // Role-specific profiles: owner read/write, admin read all
    match /artists/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isOwner(userId);
    }

    match /clients/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isOwner(userId);
    }

    match /talents/{userId} {
      allow read: if true; // Public for marketplace
      allow write: if isOwner(userId);
    }

    match /venues/{venueId} {
      allow read: if true; // Public for event creation & marketplace
      allow write: if isAuth() && resource.data.userId == request.auth.uid;
      allow create: if isAuth();
    }

    // Events: anyone can read, authenticated can create, owner can update
    match /events/{eventId} {
      allow read: if true;
      allow create: if isAuth();
      allow update: if isAuth() && resource.data.organizerId == request.auth.uid;
      allow delete: if isAuth() && resource.data.organizerId == request.auth.uid || isAdmin();
    }

    // Bookings: owner read/write, admin read all
    match /bookings/{bookingId} {
      allow read: if isAuth() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuth();
      allow update, delete: if isAuth() && resource.data.userId == request.auth.uid;
    }

    // Conversations: only participants can read/write
    match /conversations/{convoId} {
      allow read: if isAuth() && request.auth.uid in resource.data.participants;
      allow create: if isAuth();
      allow update: if isAuth() && request.auth.uid in resource.data.participants;

      // Messages subcollection: only conversation participants
      match /messages/{messageId} {
        allow read: if isAuth() && request.auth.uid in get(/databases/$(database)/documents/conversations/$(convoId)).data.participants;
        allow create: if isAuth() && request.auth.uid in get(/databases/$(database)/documents/conversations/$(convoId)).data.participants;
      }
    }

    // Notifications: owner only
    match /notifications/{notifId} {
      allow read: if isAuth() && resource.data.userId == request.auth.uid;
      allow create: if isAuth();
      allow update: if isAuth() && resource.data.userId == request.auth.uid;
    }

    // Services: anyone can read, owner can write
    match /services/{serviceId} {
      allow read: if true;
      allow create: if isAuth();
      allow update, delete: if isAuth() && resource.data.userId == request.auth.uid;
    }

    // Tickets: owner read, admin read all
    match /tickets/{ticketId} {
      allow read: if isAuth() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuth();
    }

    // Categories: anyone can read, admin can write
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Audit Logs: admin only
    match /auditLogs/{logId} {
      allow read: if isAdmin();
      allow create: if isAuth(); // System can create logs
    }

    // Approvals: admin can read/write
    match /approvals/{approvalId} {
      allow read: if isAdmin();
      allow create: if isAuth();
      allow update: if isAdmin();
    }
  }
}
